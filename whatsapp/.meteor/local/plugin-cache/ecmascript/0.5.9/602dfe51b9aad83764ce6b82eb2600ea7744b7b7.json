{"metadata":{"usedHelpers":["inherits","possibleConstructorReturn","classCallCheck"],"marked":[],"modules":{"imports":[{"source":"ionic-scripts","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Ionic"}]},{"source":"meteor/underscore","imported":["_"],"specifiers":[{"kind":"named","imported":"_","local":"_"}]},{"source":"meteor/meteor","imported":["Meteor"],"specifiers":[{"kind":"named","imported":"Meteor","local":"Meteor"}]},{"source":"meteor/okland:camera-ui","imported":["MeteorCameraUI"],"specifiers":[{"kind":"named","imported":"MeteorCameraUI","local":"MeteorCameraUI"}]},{"source":"angular-ecmascript/module-helpers","imported":["Controller"],"specifiers":[{"kind":"named","imported":"Controller","local":"Controller"}]},{"source":"../../../lib/collections","imported":["Chats","Messages"],"specifiers":[{"kind":"named","imported":"Chats","local":"Chats"},{"kind":"named","imported":"Messages","local":"Messages"}]}],"exports":{"exported":["ChatCtrl"],"specifiers":[{"kind":"local","local":"ChatCtrl","exported":"default"}]}}},"options":{"filename":"/client/scripts/controllers/chat.controller.js","filenameRelative":"/client/scripts/controllers/chat.controller.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/client/scripts/controllers/chat.controller.js.map","sourceFileName":"/client/scripts/controllers/chat.controller.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"chat.controller"},"ignored":false,"code":"var _classCallCheck;module.import('babel-runtime/helpers/classCallCheck',{\"default\":function(v){_classCallCheck=v}});var _possibleConstructorReturn;module.import('babel-runtime/helpers/possibleConstructorReturn',{\"default\":function(v){_possibleConstructorReturn=v}});var _inherits;module.import('babel-runtime/helpers/inherits',{\"default\":function(v){_inherits=v}});var Ionic;module.import('ionic-scripts',{\"default\":function(v){Ionic=v}});var _;module.import('meteor/underscore',{\"_\":function(v){_=v}});var Meteor;module.import('meteor/meteor',{\"Meteor\":function(v){Meteor=v}});var MeteorCameraUI;module.import('meteor/okland:camera-ui',{\"MeteorCameraUI\":function(v){MeteorCameraUI=v}});var Controller;module.import('angular-ecmascript/module-helpers',{\"Controller\":function(v){Controller=v}});var Chats,Messages;module.import('../../../lib/collections',{\"Chats\":function(v){Chats=v},\"Messages\":function(v){Messages=v}});\n\n\n\n\n\n\n\n\n\nvar ChatCtrl = function (_Controller) {\n  _inherits(ChatCtrl, _Controller);\n\n  function ChatCtrl() {\n    _classCallCheck(this, ChatCtrl);\n\n    var _this = _possibleConstructorReturn(this, _Controller.apply(this, arguments));\n\n    _this.chatId = _this.$stateParams.chatId;\n    _this.isIOS = Ionic.Platform.isWebView() && Ionic.Platform.isIOS();\n    _this.isCordova = Meteor.isCordova;\n\n    _this.helpers({\n      messages: function () {\n        function messages() {\n          return Messages.find({ chatId: this.chatId });\n        }\n\n        return messages;\n      }(),\n      data: function () {\n        function data() {\n          return Chats.findOne(this.chatId);\n        }\n\n        return data;\n      }()\n    });\n\n    _this.autoScroll();\n    return _this;\n  }\n\n  ChatCtrl.prototype.sendPicture = function () {\n    function sendPicture() {\n      var _this2 = this;\n\n      MeteorCameraUI.getPicture({}, function (err, data) {\n        if (err) return _this2.handleError(err);\n\n        _this2.callMethod('newMessage', {\n          picture: data,\n          type: 'picture',\n          chatId: _this2.chatId\n        });\n      });\n    }\n\n    return sendPicture;\n  }();\n\n  ChatCtrl.prototype.sendMessage = function () {\n    function sendMessage() {\n      if (_.isEmpty(this.message)) return;\n\n      this.callMethod('newMessage', {\n        text: this.message,\n        type: 'text',\n        chatId: this.chatId\n      });\n\n      delete this.message;\n    }\n\n    return sendMessage;\n  }();\n\n  ChatCtrl.prototype.inputUp = function () {\n    function inputUp() {\n      if (this.isIOS) {\n        this.keyboardHeight = 216;\n      }\n\n      this.scrollBottom(true);\n    }\n\n    return inputUp;\n  }();\n\n  ChatCtrl.prototype.inputDown = function () {\n    function inputDown() {\n      if (this.isIOS) {\n        this.keyboardHeight = 0;\n      }\n\n      this.$ionicScrollDelegate.$getByHandle('chatScroll').resize();\n    }\n\n    return inputDown;\n  }();\n\n  ChatCtrl.prototype.closeKeyboard = function () {\n    function closeKeyboard() {\n      if (this.isCordova) {\n        cordova.plugins.Keyboard.close();\n      }\n    }\n\n    return closeKeyboard;\n  }();\n\n  ChatCtrl.prototype.autoScroll = function () {\n    function autoScroll() {\n      var _this3 = this;\n\n      var recentMessagesNum = this.messages.length;\n\n      this.autorun(function () {\n        var currMessagesNum = _this3.getCollectionReactively('messages').length;\n        var animate = recentMessagesNum != currMessagesNum;\n        recentMessagesNum = currMessagesNum;\n        _this3.scrollBottom(animate);\n      });\n    }\n\n    return autoScroll;\n  }();\n\n  ChatCtrl.prototype.scrollBottom = function () {\n    function scrollBottom(animate) {\n      var _this4 = this;\n\n      this.$timeout(function () {\n        _this4.$ionicScrollDelegate.$getByHandle('chatScroll').scrollBottom(animate);\n      }, 300);\n    }\n\n    return scrollBottom;\n  }();\n\n  ChatCtrl.prototype.handleError = function () {\n    function handleError(err) {\n      if (err.error == 'cancel') return;\n      this.$log.error('Profile save error ', err);\n\n      this.$ionicPopup.alert({\n        title: err.reason || 'Save failed',\n        template: 'Please try again',\n        okType: 'button-positive button-clear'\n      });\n    }\n\n    return handleError;\n  }();\n\n  return ChatCtrl;\n}(Controller);\n\nmodule.export(\"default\",exports.default=(ChatCtrl));\n\n\nChatCtrl.$name = 'ChatCtrl';\nChatCtrl.$inject = ['$stateParams', '$timeout', '$ionicScrollDelegate', '$ionicPopup', '$log'];","ast":null,"map":{"version":3,"sources":["/client/scripts/controllers/chat.controller.js"],"names":["Ionic","_","Meteor","MeteorCameraUI","Controller","Chats","Messages","ChatCtrl","arguments","chatId","$stateParams","isIOS","Platform","isWebView","isCordova","helpers","messages","find","data","findOne","autoScroll","sendPicture","getPicture","err","handleError","callMethod","picture","type","sendMessage","isEmpty","message","text","inputUp","keyboardHeight","scrollBottom","inputDown","$ionicScrollDelegate","$getByHandle","resize","closeKeyboard","cordova","plugins","Keyboard","close","recentMessagesNum","length","autorun","currMessagesNum","getCollectionReactively","animate","$timeout","error","$log","$ionicPopup","alert","title","reason","template","okType","$name","$inject"],"mappings":"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","file":"/client/scripts/controllers/chat.controller.js.map","sourcesContent":["import Ionic from 'ionic-scripts';\nimport { _ } from 'meteor/underscore';\nimport { Meteor } from 'meteor/meteor';\nimport { MeteorCameraUI } from 'meteor/okland:camera-ui';\nimport { Controller } from 'angular-ecmascript/module-helpers';\nimport { Chats, Messages } from '../../../lib/collections';\n\nexport default class ChatCtrl extends Controller {\n  constructor() {\n    super(...arguments);\n\n    this.chatId = this.$stateParams.chatId;\n    this.isIOS = Ionic.Platform.isWebView() && Ionic.Platform.isIOS();\n    this.isCordova = Meteor.isCordova;\n\n    this.helpers({\n      messages() {\n        return Messages.find({ chatId: this.chatId });\n      },\n      data() {\n        return Chats.findOne(this.chatId);\n      }\n    });\n\n    this.autoScroll();\n  }\n\n  sendPicture() {\n    MeteorCameraUI.getPicture({}, (err, data) => {\n      if (err) return this.handleError(err);\n\n      this.callMethod('newMessage', {\n        picture: data,\n        type: 'picture',\n        chatId: this.chatId\n      });\n    });\n  }\n\n  sendMessage() {\n    if (_.isEmpty(this.message)) return;\n\n    this.callMethod('newMessage', {\n      text: this.message,\n      type: 'text',\n      chatId: this.chatId\n    });\n\n    delete this.message;\n  }\n\n  inputUp () {\n    if (this.isIOS) {\n      this.keyboardHeight = 216;\n    }\n\n    this.scrollBottom(true);\n  }\n\n  inputDown () {\n    if (this.isIOS) {\n      this.keyboardHeight = 0;\n    }\n\n    this.$ionicScrollDelegate.$getByHandle('chatScroll').resize();\n  }\n\n  closeKeyboard () {\n    if (this.isCordova) {\n      cordova.plugins.Keyboard.close();\n    }\n  }\n\n  autoScroll() {\n    let recentMessagesNum = this.messages.length;\n\n    this.autorun(() => {\n      const currMessagesNum = this.getCollectionReactively('messages').length;\n      const animate = recentMessagesNum != currMessagesNum;\n      recentMessagesNum = currMessagesNum;\n      this.scrollBottom(animate);\n    });\n  }\n\n  scrollBottom(animate) {\n    this.$timeout(() => {\n      this.$ionicScrollDelegate.$getByHandle('chatScroll').scrollBottom(animate);\n    }, 300);\n  }\n\n  handleError(err) {\n    if (err.error == 'cancel') return;\n    this.$log.error('Profile save error ', err);\n\n    this.$ionicPopup.alert({\n      title: err.reason || 'Save failed',\n      template: 'Please try again',\n      okType: 'button-positive button-clear'\n    });\n  }\n}\n\nChatCtrl.$name = 'ChatCtrl';\nChatCtrl.$inject = ['$stateParams', '$timeout', '$ionicScrollDelegate', '$ionicPopup', '$log'];\n"]},"hash":"602dfe51b9aad83764ce6b82eb2600ea7744b7b7"}
